<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://api.github.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob:; object-src blob:; connect-src 'self' https://api.github.com https://cdn.jsdelivr.net raw.githubusercontent.com blob:;">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>MYR Secure Vault</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js/dist/zip.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg: #F9F8F6;
            --surface: #FFFFFF;
            --text: #2D2C2A;
            --text-muted: #7A7873;
            --accent: #D4AF37;
            --accent-hover: #C5A028;
            --border: #EAE6DF;
            --danger: #E06666;
            --success: #6E9C7B;
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.03);
            --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.08);
            --radius: 16px;
            --font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        [data-theme="dark"] {
            --bg: #141413;
            --surface: #1E1D1C;
            --text: #F0EFEA;
            --text-muted: #A3A09A;
            --accent: #D4AF37;
            --accent-hover: #E3C154;
            --border: #33312E;
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 12px 32px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font); background: var(--bg); background-image: radial-gradient(var(--border) 1px, transparent 1px); background-size: 24px 24px; color: var(--text); transition: background 0.4s ease, color 0.4s ease; line-height: 1.6; -webkit-tap-highlight-color: transparent; min-height: 100vh; display: flex; flex-direction: column; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 1.2rem 5%; background: rgba(var(--surface), 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 50; }
        .logo { font-size: 1.4rem; font-weight: 700; letter-spacing: 0.5px; color: var(--text); display: flex; align-items: center; gap: 8px;}
        .logo span { color: var(--accent); }
        
        button { cursor: pointer; border: none; font-family: inherit; transition: all 0.2s ease; outline: none; }
        button:active { transform: scale(0.97); }
        button:disabled { cursor: not-allowed; opacity: 0.7; transform: none; }
        #theme-toggle { background: var(--border); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--text); }
        #theme-toggle:hover { background: var(--text); color: var(--bg); }
        
        main { width: 100%; max-width: 900px; margin: 2rem auto; padding: 0 1.5rem; flex: 1; }
        
        .view { display: none; opacity: 0; animation: fadeIn 0.4s forwards; }
        .view.active { display: block; }
        .hidden { display: none !important; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        h1, h2, h3 { font-weight: 600; margin-bottom: 0.5rem; letter-spacing: -0.3px; }
        .subtitle { color: var(--text-muted); margin-bottom: 2rem; font-size: 0.95rem; }
        
        .hero-banner { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 2rem; margin-bottom: 2rem; text-align: center; box-shadow: var(--shadow-sm); }
        .hero-banner svg { color: var(--accent); margin-bottom: 1rem; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .grid.list-view { display: flex; flex-direction: column; gap: 0.8rem; }
        
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow-sm); transition: all 0.3s ease; }
        #zip-list .card { cursor: pointer; position: relative; overflow: hidden; }
        #zip-list .card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--accent); opacity: 0; transition: opacity 0.3s; }
        #zip-list .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: transparent; }
        #zip-list .card:hover::before { opacity: 1; }
        
        .card-title { font-size: 1.15rem; word-break: break-all; display: flex; align-items: center; gap: 8px; }
        .card-meta { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.8rem; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 0.8rem;}
        
        .detail-card { max-width: 480px; margin: 0 auto; text-align: center; }
        .meta-data { text-align: left; margin: 1.5rem 0; background: var(--bg); padding: 1.2rem; border-radius: 12px; font-size: 0.9rem; border: 1px solid var(--border); }
        .meta-data p { margin-bottom: 0.5rem; display: flex; justify-content: space-between; }
        .meta-data p:last-child { margin-bottom: 0; }
        
        .primary-btn, .danger-btn, .secondary-btn { padding: 0.9rem 1.5rem; border-radius: 10px; font-weight: 600; width: 100%; font-size: 1rem; }
        .primary-btn { background: var(--accent); color: #fff; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3); }
        .primary-btn:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4); }
        
        .danger-btn { background: var(--danger); color: #fff; }
        .secondary-btn { background: var(--bg); border: 1px solid var(--border); color: var(--text); }
        .back-btn { background: none; color: var(--text-muted); margin-bottom: 1.5rem; font-weight: 500; font-size: 1rem; display: flex; align-items: center; gap: 5px; }
        .back-btn:hover { color: var(--text); }
        
        input[type="password"], input[type="text"] { width: 100%; padding: 1rem; margin-top: 1rem; border: 2px solid var(--border); border-radius: 10px; background: var(--bg); color: var(--text); outline: none; transition: border-color 0.3s; font-family: var(--font); font-size: 1rem; }
        input:focus { border-color: var(--accent); }
        .error-text { color: var(--danger); font-size: 0.9rem; margin-top: 0.8rem; font-weight: 500; }
        
        .progress-container { width: 100%; background: var(--border); border-radius: 8px; height: 8px; margin-top: 1rem; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s ease; border-radius: 8px; }
        .progress-text { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; display: block; text-align: center; }
        .indeterminate .progress-bar { width: 50%; animation: pulse-load 1.5s infinite ease-in-out; }
        @keyframes pulse-load { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
        
        #timer-bar { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.8rem 5%; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: var(--accent); box-shadow: var(--shadow-sm); }
        #countdown { font-variant-numeric: tabular-nums; font-size: 1.2rem; background: var(--bg); padding: 0.2rem 0.8rem; border-radius: 6px; margin-left: 10px;}
        #close-vault-btn { width: auto; padding: 0.5rem 1.2rem; font-size: 0.9rem; margin: 0; }
        
        .vault-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .vault-toolbar { display: flex; gap: 1rem; margin-bottom: 2rem; }
        #vault-search { margin-top: 0; flex-grow: 1; box-shadow: var(--shadow-sm); }
        
        .file-card { display: flex; align-items: center; padding: 1rem 1.2rem; justify-content: space-between; gap: 1rem; }
        .folder-card { cursor: pointer; background: rgba(212, 175, 55, 0.05); border-color: rgba(212, 175, 55, 0.2); }
        .folder-card:hover { border-color: var(--accent); }
        .file-info { display: flex; align-items: center; gap: 1rem; overflow: hidden; flex: 1; }
        .file-icon { font-size: 1.8rem; }
        .file-name { font-weight: 500; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-actions { display: flex; gap: 0.5rem; }
        
        .icon-btn { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; color: var(--text); box-shadow: var(--shadow-sm); transition: all 0.2s; }
        .icon-btn:hover { background: var(--accent); color: #fff; border-color: var(--accent); }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; padding: 1rem; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--surface); border-radius: var(--radius); width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--shadow-lg); transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .modal.active .modal-content { transform: translateY(0); }
        
        .small-modal { max-width: 400px; padding: 2rem; text-align: center; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.2rem 1.5rem; border-bottom: 1px solid var(--border); background: var(--bg); }
        .close-btn { font-size: 1.5rem; background: none; color: var(--text-muted); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .close-btn:hover { background: var(--border); color: var(--text); }
        
        #preview-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; align-items: center; background: var(--bg); }
        #preview-body img, #preview-body video { max-width: 100%; border-radius: 8px; box-shadow: var(--shadow-sm); background: var(--surface); }
        #preview-body pre { width: 100%; background: var(--surface); padding: 1.5rem; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; font-family: monospace; font-size: 0.85rem; border: 1px solid var(--border); color: var(--text); }
        
        .vcf-card { width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; text-align: left; }
        .vcf-card h3 { color: var(--accent); margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        .vcf-card p { margin-bottom: 0.5rem; display: flex; gap: 10px; }
        .vcf-card strong { width: 60px; color: var(--text-muted); }

        .csv-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; background: var(--surface); }
        .csv-table th { background: var(--bg); font-weight: 600; }
        .csv-table th, .csv-table td { border: 1px solid var(--border); padding: 0.75rem; text-align: left; }
        .modal-actions { display: flex; gap: 1rem; margin-top: 2rem; }
        
        .empty-state { text-align: center; padding: 3rem 1rem; color: var(--text-muted); grid-column: 1 / -1; }
    </style>
</head>
<body>

    <header>
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent)"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            MYR <span>Vault</span>
        </div>
        <button id="theme-toggle" aria-label="Toggle Dark Mode">üåì</button>
    </header>

    <div id="timer-bar" class="hidden">
        <div style="display:flex; align-items:center;">Session <span id="countdown">05:00</span></div>
        <button id="close-vault-btn" class="danger-btn">Lock</button>
    </div>

    <main>
        <section id="view-home" class="view active">
            <div class="hero-banner">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>
                <h1>Secure Cloud Archives</h1>
                <p class="subtitle" id="repo-status">Connecting to remote vault...</p>
            </div>
            <div id="zip-list" class="grid"></div>
        </section>

        <section id="view-details" class="view">
            <button class="back-btn" onclick="app.showHome()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg> Back
            </button>
            <div class="card detail-card">
                <h2 id="detail-title"></h2>
                <div class="meta-data">
                    <p><span>File:</span> <strong id="detail-filename"></strong></p>
                    <p><span>Size:</span> <strong id="detail-size"></strong></p>
                    <p><span>SHA:</span> <strong id="detail-sha" style="font-family: monospace;"></strong></p>
                </div>
                
                <div id="download-ui">
                    <button id="download-unlock-btn" class="primary-btn">Download Archive</button>
                    <div id="download-progress-container" class="hidden">
                        <div class="progress-container" id="dl-prog-wrap"><div class="progress-bar" id="dl-prog-bar"></div></div>
                        <span class="progress-text" id="dl-prog-text">Connecting...</span>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-password" class="view">
            <div class="card detail-card">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="color: var(--accent); margin-bottom: 1rem;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                <h2>Unlock Archive</h2>
                <p class="subtitle">Enter AES-256 password for client-side decryption.</p>
                <input type="password" id="vault-password" placeholder="Enter Password" autocomplete="off">
                <p id="password-error" class="error-text hidden"></p>
                
                <div id="decrypt-progress-container" class="hidden" style="margin-top: 1.5rem; text-align: left;">
                    <div class="progress-container"><div class="progress-bar" id="dc-prog-bar"></div></div>
                    <span class="progress-text" id="dc-prog-text">Decrypting...</span>
                </div>

                <button id="unlock-btn" class="primary-btn" style="margin-top: 1rem;">Decrypt</button>
            </div>
        </section>

        <section id="view-vault" class="view">
            <div class="vault-header">
                <div>
                    <h2 style="margin-bottom:0;" id="vault-title-display">Decrypted Files</h2>
                    <span class="subtitle" style="font-size:0.85rem;" id="vault-stats">0 files</span>
                </div>
            </div>
            <div class="vault-toolbar">
                <input type="text" id="vault-search" placeholder="Search decrypted files..." autocomplete="off">
                <button id="toggle-layout-btn" class="icon-btn" title="Toggle Grid/List">üî≤</button>
            </div>
            <div id="vault-path" style="margin-bottom: 1rem; font-size: 0.9rem; color: var(--accent); font-weight: 500; word-break: break-all;"></div>
            
            <div id="vault-contents" class="grid list-view"></div>
        </section>
    </main>

    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="preview-title" style="font-size: 1.1rem; margin:0; max-width: 80%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Preview</h3>
                <button id="close-preview" class="close-btn">√ó</button>
            </div>
            <div id="preview-body"></div>
        </div>
    </div>

    <div id="warning-modal" class="modal">
        <div class="modal-content small-modal">
            <h3 style="color: var(--danger);">Lock Vault?</h3>
            <p style="margin: 1rem 0; font-size: 0.95rem; color: var(--text-muted);">This instantly wipes all decrypted data from device memory and revokes secure blobs.</p>
            <div class="modal-actions">
                <button id="cancel-close" class="secondary-btn">Cancel</button>
                <button id="confirm-close" class="danger-btn">Wipe & Lock</button>
            </div>
        </div>
    </div>

    <script>
    /** * CONFIGURATION */
    const CONFIG = {
        GITHUB_REPO: 'unskyit/vault', 
        ZIPS_FOLDER_PATH: 'zips'
    };

    zip.configure({ useWebWorkers: false });

    const app = (() => {
        let manifest = [];
        let activeZip = null;
        let encryptedBlob = null;
        let decryptedFiles = []; 
        let sessionTimer = null;
        let views = {}; 
        
        let currentFolder = ""; // Folder Navigation State
        let isListView = true;

        const getMimeType = (ext) => {
            const mimes = {
                'mp4': 'video/mp4', 'webm': 'video/webm', 'avi': 'video/x-msvideo',
                'pdf': 'application/pdf',
                'jpg': 'image/jpeg', 'jpeg': 'image/jpeg', 'png': 'image/png', 'gif': 'image/gif', 'webp': 'image/webp',
                'mp3': 'audio/mpeg', 'wav': 'audio/wav',
                'vcf': 'text/vcard', 'txt': 'text/plain', 'json': 'application/json', 'csv': 'text/csv'
            };
            return mimes[ext] || 'application/octet-stream';
        };

        const init = async () => {
            views = {
                home: document.getElementById('view-home'),
                details: document.getElementById('view-details'),
                password: document.getElementById('view-password'),
                vault: document.getElementById('view-vault')
            };

            initTheme();
            bindEvents();
            await fetchGitHubDirectory();
        };

        const initTheme = () => {
            if (localStorage.getItem('theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
            document.getElementById('theme-toggle').addEventListener('click', () => {
                const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
            });
        };

        const bindEvents = () => {
            document.getElementById('download-unlock-btn').addEventListener('click', fetchWithProgress);
            document.getElementById('unlock-btn').addEventListener('click', attemptUnlock);
            document.getElementById('vault-password').addEventListener('keypress', (e) => { if(e.key === 'Enter') attemptUnlock(); });
            
            document.getElementById('vault-search').addEventListener('input', (e) => {
                renderVaultUI(e.target.value.toLowerCase());
            });

            document.getElementById('toggle-layout-btn').addEventListener('click', () => {
                isListView = !isListView;
                const container = document.getElementById('vault-contents');
                isListView ? container.classList.add('list-view') : container.classList.remove('list-view');
            });
            
            const warnModal = document.getElementById('warning-modal');
            const prevModal = document.getElementById('preview-modal');
            
            document.getElementById('close-vault-btn').addEventListener('click', () => warnModal.classList.add('active'));
            document.getElementById('cancel-close').addEventListener('click', () => warnModal.classList.remove('active'));
            document.getElementById('confirm-close').addEventListener('click', forceWipeMemory);
            
            document.getElementById('close-preview').addEventListener('click', () => {
                prevModal.classList.remove('active');
                setTimeout(() => document.getElementById('preview-body').innerHTML = '', 300);
            });

            document.addEventListener('contextmenu', (e) => { if(views.vault.classList.contains('active')) e.preventDefault(); });
        };

        const showView = (v) => {
            Object.values(views).forEach(el => el.classList.remove('active'));
            views[v].classList.add('active');
            
            const pwdInput = document.getElementById('vault-password');
            const pwdError = document.getElementById('password-error');
            if (pwdInput) pwdInput.value = '';
            if (pwdError) pwdError.classList.add('hidden');
        };

        const formatBytes = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024, sizes = ['Bytes', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const fetchGitHubDirectory = async () => {
            const statusEl = document.getElementById('repo-status');
            try {
                const url = `https://api.github.com/repos/${CONFIG.GITHUB_REPO}/contents/${CONFIG.ZIPS_FOLDER_PATH}`;
                const res = await fetch(url);
                if (res.status === 403) throw new Error("GitHub API rate limit exceeded.");
                if (!res.ok) throw new Error("Folder not found. Ensure repository and folder exist.");
                
                const data = await res.json();
                manifest = data.filter(item => item.name.endsWith('.zip')).map(item => ({
                    id: item.sha, filename: item.name,
                    title: item.name.replace('.zip', '').replace(/[-_]/g, ' ').toUpperCase(),
                    size: formatBytes(item.size), downloadUrl: item.download_url
                }));

                statusEl.innerText = `${manifest.length} secure archives available`;
                document.getElementById('zip-list').innerHTML = manifest.map(item => `
                    <div class="card" onclick="app.showDetails('${item.id}')">
                        <h3 class="card-title"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color:var(--accent)"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> ${item.title}</h3>
                        <div class="card-meta"><span>${item.filename}</span> <span>${item.size}</span></div>
                    </div>
                `).join('');
            } catch (e) { statusEl.innerHTML = `<span style="color:var(--danger)">Error: ${e.message}</span>`; }
        };

        const showDetails = (id) => {
            activeZip = manifest.find(i => i.id === id);
            document.getElementById('detail-title').innerText = activeZip.title;
            document.getElementById('detail-filename').innerText = activeZip.filename;
            document.getElementById('detail-size').innerText = activeZip.size;
            document.getElementById('detail-sha').innerText = activeZip.id.substring(0, 12) + '...';
            
            document.getElementById('download-unlock-btn').classList.remove('hidden');
            document.getElementById('download-progress-container').classList.add('hidden');
            document.getElementById('dl-prog-wrap').classList.remove('indeterminate');
            document.getElementById('dl-prog-bar').style.width = '0%';
            
            showView('details');
        };

        const fetchWithProgress = async () => {
            const btn = document.getElementById('download-unlock-btn');
            const progContainer = document.getElementById('download-progress-container');
            const progBar = document.getElementById('dl-prog-bar');
            const progText = document.getElementById('dl-prog-text');

            btn.classList.add('hidden');
            progContainer.classList.remove('hidden');
            progText.innerText = "Initiating secure connection...";

            try {
                const response = await fetch(activeZip.downloadUrl);
                if (!response.ok) throw new Error("Network response was not ok");
                const total = parseInt(response.headers.get('content-length') || '0', 10);
                if (total === 0) document.getElementById('dl-prog-wrap').classList.add('indeterminate');

                let loaded = 0;
                const reader = response.body.getReader();
                const chunks = [];

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    loaded += value.length;
                    
                    if (total > 0) {
                        const percent = Math.round((loaded / total) * 100);
                        progBar.style.width = `${percent}%`;
                        progText.innerText = `Downloading to memory: ${percent}%`;
                    }
                }

                progBar.style.width = '100%';
                progText.innerText = "Download complete. Preparing buffer...";
                document.getElementById('dl-prog-wrap').classList.remove('indeterminate');
                
                encryptedBlob = new Blob(chunks);
                setTimeout(() => showView('password'), 600);
            } catch (e) {
                progText.innerText = "Error loading archive.";
                progText.style.color = 'var(--danger)';
            }
        };

        const applyLockout = () => {
            const btn = document.getElementById('unlock-btn');
            const input = document.getElementById('vault-password');
            const err = document.getElementById('password-error');
            
            let timeLeft = 30;
            input.disabled = true;
            btn.disabled = true;
            err.classList.remove('hidden');
            
            const tick = setInterval(() => {
                err.innerText = `Incorrect password. Vault locked for ${timeLeft}s.`;
                btn.innerText = `Locked (${timeLeft}s)`;
                timeLeft--;
                if (timeLeft < 0) {
                    clearInterval(tick);
                    input.disabled = false;
                    btn.disabled = false;
                    btn.innerText = "Decrypt";
                    err.classList.add('hidden');
                    input.value = "";
                    input.focus();
                }
            }, 1000);
        };

        const attemptUnlock = async () => {
            const pwdInput = document.getElementById('vault-password');
            const pwd = pwdInput.value;
            if (!pwd) return;

            const btn = document.getElementById('unlock-btn');
            const progContainer = document.getElementById('decrypt-progress-container');
            const progBar = document.getElementById('dc-prog-bar');
            const progText = document.getElementById('dc-prog-text');

            btn.classList.add('hidden');
            progContainer.classList.remove('hidden');
            document.getElementById('password-error').classList.add('hidden');
            progBar.style.width = '5%';
            progText.innerText = "Verifying AES-256 key...";

            try {
                const zipReader = new zip.ZipReader(new zip.BlobReader(encryptedBlob), { password: pwd });
                const entries = await zipReader.getEntries();
                if (!entries.length) throw new Error("Archive is empty.");

                // Test extraction to verify password
                const testFile = entries.find(e => !e.directory);
                if (testFile) await testFile.getData(new zip.Uint8ArrayWriter(), { length: 1 });

                progText.innerText = "Key verified. Extracting contents to memory...";
                await processToMemory(entries, progBar, progText);
                
                pwdInput.value = ''; 
                initSecureTimer();

            } catch (e) {
                btn.classList.remove('hidden');
                progContainer.classList.add('hidden');
                applyLockout(); // Start 30s penalty
            }
        };

        const processToMemory = async (entries, progBar, progText) => {
            decryptedFiles = [];
            const filesToExtract = entries.filter(e => !e.directory);
            const totalFiles = filesToExtract.length;
            let currentFile = 0;

            for (const entry of filesToExtract) {
                const fullPath = entry.filename; // e.g., "folder/subfolder/file.jpg"
                const safeName = fullPath.split('/').pop().replace(/[^a-zA-Z0-9.\-_ ()]/g, '');
                if (!safeName) continue;
                
                const ext = safeName.split('.').pop().toLowerCase();
                const mime = getMimeType(ext); // INJECT MIME TYPE

                const blob = await entry.getData(new zip.BlobWriter(mime), {
                    onprogress: (index, max) => {
                        const fileProgress = index / max;
                        const overallProgress = ((currentFile + fileProgress) / totalFiles) * 100;
                        progBar.style.width = `${Math.min(overallProgress, 100)}%`;
                    }
                });

                decryptedFiles.push({
                    fullPath: fullPath,
                    pathDir: fullPath.substring(0, fullPath.lastIndexOf('/') + 1), // "folder/subfolder/"
                    name: safeName, 
                    ext: ext,
                    url: URL.createObjectURL(blob), 
                    rawBlob: blob,
                    index: decryptedFiles.length // Keep original reference for previewing
                });
                currentFile++;
            }

            progText.innerText = "Extraction complete. Building UI...";
            document.getElementById('vault-title-display').innerText = activeZip.title;
            document.getElementById('vault-stats').innerText = `${totalFiles} items securely decrypted`;
            
            currentFolder = ""; // Reset to root
            renderVaultUI();
            
            setTimeout(() => {
                showView('vault');
                document.getElementById('unlock-btn').classList.remove('hidden');
                document.getElementById('decrypt-progress-container').classList.add('hidden');
            }, 500);
        };

        const getIcon = (ext) => {
            const i = { pdf:'üìÑ', txt:'üìù', md:'üìù', csv:'üìä', json:'‚öôÔ∏è', jpg:'üñºÔ∏è', png:'üñºÔ∏è', mp4:'üé•', mp3:'üéµ', zip:'üì¶', db:'üóÑÔ∏è', vcf:'üìá' };
            return i[ext] || 'üìÑ';
        };

        // Handles folder navigation and search filtering
        const renderVaultUI = (searchQuery = "") => {
            const container = document.getElementById('vault-contents');
            const pathDisplay = document.getElementById('vault-path');
            
            pathDisplay.innerText = currentFolder === "" ? "/ Root" : `/ ${currentFolder}`;
            
            let html = "";
            
            // If we are searching, flatten everything and ignore folders
            if (searchQuery) {
                const results = decryptedFiles.filter(f => f.name.toLowerCase().includes(searchQuery));
                if (results.length === 0) {
                    container.innerHTML = `<div class="empty-state">No files match "${searchQuery}"</div>`;
                    return;
                }
                html += results.map(f => generateFileHTML(f)).join('');
                container.innerHTML = html;
                return;
            }

            // Normal Folder View
            const folders = new Set();
            const filesInDir = [];

            decryptedFiles.forEach(f => {
                if (f.pathDir.startsWith(currentFolder)) {
                    const relativePath = f.pathDir.substring(currentFolder.length);
                    if (relativePath === "") {
                        filesInDir.push(f); // File is exactly in this directory
                    } else {
                        // Extract the next immediate folder name
                        const nextFolder = relativePath.split('/')[0];
                        folders.add(currentFolder + nextFolder + '/');
                    }
                }
            });

            // Level Up Button
            if (currentFolder !== "") {
                const parentDir = currentFolder.split('/').slice(0, -2).join('/');
                const target = parentDir === "" ? "" : parentDir + "/";
                html += `
                    <div class="card file-card folder-card" onclick="app.navTo('${target}')">
                        <div class="file-info"><span class="file-icon">‚¨ÜÔ∏è</span><span class="file-name">.. (Level Up)</span></div>
                    </div>`;
            }

            // Render Subfolders
            Array.from(folders).sort().forEach(folderPath => {
                const folderName = folderPath.split('/').slice(-2)[0];
                html += `
                    <div class="card file-card folder-card" onclick="app.navTo('${folderPath}')">
                        <div class="file-info"><span class="file-icon">üìÅ</span><span class="file-name">${folderName}</span></div>
                        <span style="color:var(--text-muted); font-size: 0.8rem;">Open</span>
                    </div>`;
            });

            // Render Files
            filesInDir.sort((a, b) => a.ext.localeCompare(b.ext) || a.name.localeCompare(b.name)).forEach(f => {
                html += generateFileHTML(f);
            });

            if (html === "") html = `<div class="empty-state">This folder is empty.</div>`;
            container.innerHTML = html;
        };

        const generateFileHTML = (f) => `
            <div class="card file-card">
                <div class="file-info">
                    <span class="file-icon">${getIcon(f.ext)}</span>
                    <span class="file-name" title="${f.name}">${f.name}</span>
                </div>
                <div class="file-actions">
                    <button class="icon-btn" onclick="app.preview(${f.index})" title="Preview"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg></button>
                    <button class="icon-btn" onclick="app.save(${f.index})" title="Save"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg></button>
                </div>
            </div>`;

        const preview = async (globalIndex) => {
            const file = decryptedFiles[globalIndex];
            const body = document.getElementById('preview-body');
            document.getElementById('preview-title').innerText = file.name;
            body.innerHTML = '<div style="text-align:center; padding: 2rem;"><div class="progress-container indeterminate" style="width:100px; margin:auto;"><div class="progress-bar"></div></div><p style="margin-top:1rem; color:var(--text-muted);">Rendering...</p></div>';
            document.getElementById('preview-modal').classList.add('active');

            try {
                if (['jpg','jpeg','png','gif','webp','svg'].includes(file.ext)) {
                    body.innerHTML = `<img src="${file.url}">`;
                } else if (['mp4','webm','avi'].includes(file.ext)) {
                    body.innerHTML = `<video src="${file.url}" controls autoplay style="width:100%; border-radius:8px;"></video>`;
                } else if (['mp3','wav'].includes(file.ext)) {
                    body.innerHTML = `<audio src="${file.url}" controls autoplay style="width:100%"></audio>`;
                } else if (file.ext === 'pdf') {
                    // Robust PDF embed approach for Blobs
                    body.innerHTML = `<object data="${file.url}" type="application/pdf" width="100%" height="80vh" style="min-height: 500px; border-radius: 8px;">
                        <iframe src="${file.url}" width="100%" height="100%" style="border:none;">
                            <p style="padding:2rem;text-align:center;">Browser lacks PDF viewer. <a href="${file.url}" download="${file.name}">Download to view</a></p>
                        </iframe>
                    </object>`;
                } else if (file.ext === 'vcf') {
                    // VCF Contact Card Parser
                    const text = await file.rawBlob.text();
                    const cleanHtml = text.split('\n').map(line => {
                        if (line.startsWith('FN:')) return `<h3>${line.substring(3)}</h3>`;
                        if (line.startsWith('TEL')) return `<p><strong>Phone</strong> ${line.split(':')[1]}</p>`;
                        if (line.startsWith('EMAIL')) return `<p><strong>Email</strong> <a href="mailto:${line.split(':')[1]}">${line.split(':')[1]}</a></p>`;
                        return '';
                    }).join('');
                    body.innerHTML = `<div class="vcf-card">${cleanHtml || "<p>Raw VCF Data format not fully supported.</p><pre>"+text+"</pre>"}</div>`;
                } else if (['txt','md','json','xml','csv'].includes(file.ext)) {
                    const text = await file.rawBlob.text();
                    if (file.ext === 'json') { try { body.innerHTML = `<pre>${JSON.stringify(JSON.parse(text), null, 2)}</pre>`; } catch { body.innerHTML = `<pre>${text}</pre>`; } }
                    else if (file.ext === 'csv') {
                        body.innerHTML = '<div style="width:100%; overflow-x:auto;"><table class="csv-table">' + text.split('\n').map((row, i) => {
                            if(!row.trim()) return '';
                            return '<tr>' + row.split(',').map(c => i===0 ? `<th>${c.trim()}</th>` : `<td>${c.trim()}</td>`).join('') + '</tr>';
                        }).join('') + '</table></div>';
                    } else body.innerHTML = `<pre>${text}</pre>`;
                } else if (['db', 'sqlite'].includes(file.ext)) {
                    const view = new Uint8Array(await file.rawBlob.arrayBuffer());
                    let extract = "", curr = "";
                    for(let i=0; i < Math.min(view.length, 50000); i++) {
                        if(view[i] >= 32 && view[i] <= 126) curr += String.fromCharCode(view[i]);
                        else { if(curr.length > 4) extract += curr + "\n"; curr = ""; }
                    }
                    body.innerHTML = `<div><p style="color:var(--text-muted);margin-bottom:1rem;font-size:0.9rem;"><i>Binary Data File. Raw string extraction (first 50KB):</i></p><pre>${extract || "No legible strings found."}</pre></div>`;
                } else body.innerHTML = `<p style="text-align:center; padding: 2rem; color:var(--text-muted);">No in-browser preview available. Please save the file to view it natively.</p>`;
            } catch (e) { body.innerHTML = `<p class="error-text" style="text-align:center;">Preview error: ${e.message}</p>`; }
        };

        const save = (globalIndex) => {
            const a = document.createElement('a');
            a.href = decryptedFiles[globalIndex].url; a.download = decryptedFiles[globalIndex].name;
            a.click();
        };

        const initSecureTimer = () => {
            document.getElementById('timer-bar').classList.remove('hidden');
            let time = 300; 
            const update = () => document.getElementById('countdown').innerText = `${Math.floor(time/60).toString().padStart(2,'0')}:${(time%60).toString().padStart(2,'0')}`;
            update();
            sessionTimer = setInterval(() => { time--; update(); if(time <= 0) forceWipeMemory(); }, 1000);
        };

        const forceWipeMemory = () => {
            clearInterval(sessionTimer);
            document.getElementById('timer-bar').classList.add('hidden');
            document.getElementById('warning-modal').classList.remove('active');
            
            decryptedFiles.forEach(f => URL.revokeObjectURL(f.url));
            decryptedFiles = []; encryptedBlob = null; activeZip = null; currentFolder = "";
            
            document.getElementById('vault-contents').innerHTML = '';
            document.getElementById('vault-search').value = '';
            document.getElementById('preview-modal').classList.remove('active');
            setTimeout(() => document.getElementById('preview-body').innerHTML = '', 300);
            
            showView('home');
        };

        return { init, showHome: () => showView('home'), showDetails, preview, save, navTo: (path) => { currentFolder = path; renderVaultUI(); } };
    })();

    document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
